name: Deploy Minecraft Server

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Allow manual triggering

env:
  EC2_HOST: ${{ secrets.EC2_HOST }}
  EC2_USER: ${{ secrets.EC2_USER }}
  SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "$SSH_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts
        
    - name: Deploy to EC2
      run: |
        # Set environment variables for the deployment script
        export EC2_HOST="$EC2_HOST"
        export EC2_USER="$EC2_USER"
        export SSH_PRIVATE_KEY="$SSH_KEY"
        
        # Run the GitHub Actions deployment script
        chmod +x deploy-github-actions.sh
        ./deploy-github-actions.sh
        
        
    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "🎉 Deployment successful!"
          echo "🌐 Web Panel: http://$EC2_HOST:23333"
          echo "🎮 Minecraft Server: $EC2_HOST:25565"
          echo "🔐 Default Login: admin/admin"
          echo "⚠️ Remember to change the default password!"
        else
          echo "❌ Deployment failed. Check the logs above."
        fi