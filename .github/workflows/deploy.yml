name: Deploy Paper Minecraft Server

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Allow manual triggering

env:
  EC2_HOST: ${{ secrets.EC2_HOST }}
  EC2_USER: ${{ secrets.EC2_USER }}
  SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "$SSH_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts
        
    - name: Deploy Paper Server
      run: |
        # Set environment variables for the deployment script
        export EC2_HOST="$EC2_HOST"
        export EC2_USER="$EC2_USER"
        export SSH_PRIVATE_KEY="$SSH_KEY"
        
        # Run the Paper deployment script
        chmod +x deploy-paper.sh
        ./deploy-paper.sh
        
    - name: Deployment Status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "🎉 Paper server deployment successful!"
          echo "🎮 Minecraft Server: $EC2_HOST:25565"
          echo "🔧 Server Management:"
          echo "   Start: sudo systemctl start minecraft-server"
          echo "   Stop: sudo systemctl stop minecraft-server"
          echo "   Restart: sudo systemctl restart minecraft-server"
          echo "   Status: sudo systemctl status minecraft-server"
          echo "   Logs: sudo journalctl -u minecraft-server -f"
        else
          echo "❌ Paper server deployment failed. Check the logs above."
        fi