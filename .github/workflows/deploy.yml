name: Deploy to EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Allow manual triggering

env:
  EC2_HOST: ${{ secrets.EC2_HOST }}
  EC2_USER: ${{ secrets.EC2_USER }}
  SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "$SSH_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts
        
    - name: Create deployment package
      run: |
        # Create a deployment package excluding unnecessary files
        # Use a temporary directory to avoid tar including itself
        mkdir -p /tmp/deploy
        cp -r . /tmp/deploy/minestrike
        
        # Remove unnecessary files from the copy
        rm -rf /tmp/deploy/minestrike/.git
        rm -rf /tmp/deploy/minestrike/.github
        rm -rf /tmp/deploy/minestrike/server/logs
        rm -rf /tmp/deploy/minestrike/server/cache
        rm -rf /tmp/deploy/minestrike/server/libraries
        rm -rf /tmp/deploy/minestrike/server/versions
        rm -rf /tmp/deploy/minestrike/server/server.jar
        rm -rf /tmp/deploy/minestrike/logs
        find /tmp/deploy/minestrike -name "*.log" -delete
        find /tmp/deploy/minestrike -name ".DS_Store" -delete
        find /tmp/deploy/minestrike -name "*.tmp" -delete
        find /tmp/deploy/minestrike -name "*.backup" -delete
        
        # Create the tar file
        cd /tmp/deploy
        tar -czf minestrike-deploy.tar.gz minestrike/
        
        # Move it back to the working directory
        mv minestrike-deploy.tar.gz $GITHUB_WORKSPACE/
          
    - name: Upload deployment package to EC2
      run: |
        scp -i ~/.ssh/id_rsa minestrike-deploy.tar.gz $EC2_USER@$EC2_HOST:/tmp/
        
    - name: Deploy on EC2
      run: |
        ssh -i ~/.ssh/id_rsa $EC2_USER@$EC2_HOST << 'EOF'
          set -e
          
          echo "ğŸš€ Starting fresh EC2 deployment..."
          
          # Update system packages
          echo "ğŸ“¦ Updating system packages..."
          sudo apt update
          sudo apt upgrade -y
          sudo apt install -y curl wget screen netcat-openbsd unzip
          
          # Install Java 17 if not present
          echo "â˜• Installing Java 17..."
          if ! java -version 2>&1 | grep -q "17\|18\|19\|20\|21\|22"; then
            sudo apt install -y openjdk-17-jdk
          fi
          
          # Create minecraft user if not exists
          echo "ğŸ‘¤ Creating minecraft user..."
          if ! id minecraft &>/dev/null; then
            sudo useradd -r -s /bin/bash -d /opt/minecraft minecraft
          fi
          
          # Create directory structure
          echo "ğŸ“ Creating directory structure..."
          sudo mkdir -p /opt/minecraft/server
          sudo mkdir -p /opt/minecraft/logs
          sudo mkdir -p /opt/minecraft/scripts
          sudo mkdir -p /opt/backups
          sudo mkdir -p /opt/minecraft/server/mods
          sudo mkdir -p /opt/minecraft/server/plugins
          sudo mkdir -p /opt/minecraft/server/world
          sudo mkdir -p /opt/minecraft/server/config
          
        # Extract new deployment
        echo "ğŸ“¦ Extracting deployment package..."
        cd /tmp
        tar -xzf minestrike-deploy.tar.gz
        
        # Deploy server files
        echo "ğŸš€ Deploying server files..."
        sudo cp -r minestrike/scripts/ /opt/minecraft/
        sudo cp -r minestrike/server/ /opt/minecraft/
        sudo cp -r minestrike/maps/ /opt/minecraft/
          
          # Download Paper server
          echo "ğŸ“¥ Downloading Paper server..."
          cd /opt/minecraft/server
          PAPER_VERSION="1.20.4"
          PAPER_BUILD=$(curl -s "https://api.papermc.io/v2/projects/paper/versions/$PAPER_VERSION" | grep -o '"builds":\[[^]]*\]' | grep -o '[0-9]*' | tail -1)
          DOWNLOAD_URL="https://api.papermc.io/v2/projects/paper/versions/$PAPER_VERSION/builds/$PAPER_BUILD/downloads/paper-$PAPER_VERSION-$PAPER_BUILD.jar"
          
          # Ensure minecraft user can write to the directory
          sudo chown -R minecraft:minecraft /opt/minecraft/server/
          sudo -u minecraft curl -L -o server.jar "$DOWNLOAD_URL"
          
          # Set ownership
          echo "ğŸ” Setting file ownership..."
          sudo chown -R minecraft:minecraft /opt/minecraft/
          sudo chown -R minecraft:minecraft /opt/backups/
          
        # Setup systemd service
        echo "âš™ï¸ Setting up systemd service..."
        sudo cp /tmp/minestrike/scripts/minecraft-server.service /etc/systemd/system/
          sudo systemctl daemon-reload
          sudo systemctl enable minecraft-server
          
          # Install de_dust2 map as default world
          echo "ğŸ—ºï¸ Installing de_dust2 map as default world..."
          cd /opt/minecraft
          if [ -d "maps/custom/de_dust2" ]; then
            echo "âœ… Found de_dust2 map, installing..."
            sudo ./scripts/install-map.sh maps/custom/de_dust2
            echo "âœ… de_dust2 map installed successfully!"
            
            # Ensure server is restarted to pick up changes
            echo "ğŸ”„ Restarting server to apply changes..."
            sudo systemctl restart minecraft-server
            sleep 5
            echo "âœ… Server restarted successfully!"
          else
            echo "âš ï¸ de_dust2 map not found, using default world"
            # Start server if not already running
            sudo systemctl start minecraft-server
          fi
          
          # Configure firewall
          echo "ğŸ”¥ Configuring firewall..."
          sudo ufw --force enable
          sudo ufw allow 22/tcp
          sudo ufw allow 25565/tcp
          sudo ufw allow 25575/tcp
          
          # Wait and check status
          sleep 10
          echo "ğŸ“Š Server status:"
          sudo systemctl status minecraft-server --no-pager
          
          # Setup automatic elytra distribution
          echo "ğŸ® Setting up automatic elytra distribution..."
          if [ -f "/opt/minecraft/server/world/datapacks/elytra_giver/pack.mcmeta" ]; then
            echo "âœ… Elytra datapack found, enabling..."
            # Give elytra to all current players
            echo "give @a elytra 1" | sudo -u minecraft tee -a /opt/minecraft/server/console_input.txt
            echo "give @a firework_rocket 64" | sudo -u minecraft tee -a /opt/minecraft/server/console_input.txt
            echo "âœ… Elytra auto-give setup complete!"
          fi
          
          # Verify the world is correct
          echo "ğŸ—ºï¸ Verifying world configuration:"
          echo "Level name: $(cat /opt/minecraft/server/server.properties | grep level-name | cut -d'=' -f2)"
          echo "World directory: $(ls -la /opt/minecraft/server/world/ | head -5)"

        # Clean up
        rm -f /tmp/minestrike-deploy.tar.gz
        rm -rf /tmp/minestrike

          echo "âœ… Fresh deployment completed successfully!"
          echo "ğŸŒ External IP: $(curl -s ifconfig.me)"
        EOF

    - name: Verify deployment
      run: |
        ssh -i ~/.ssh/id_rsa $EC2_USER@$EC2_HOST << 'EOF'
          echo "ğŸ” Verifying fresh deployment..."

          # Check if server is running
          if sudo systemctl is-active --quiet minecraft-server; then
            echo "âœ… Server is running"
          else
            echo "âŒ Server is not running"
            sudo systemctl status minecraft-server --no-pager
            exit 1
          fi
          
          # Test port accessibility
          if nc -z localhost 25565; then
            echo "âœ… Port 25565 is accessible"
          else
            echo "âŒ Port 25565 is not accessible"
            exit 1
          fi
          
          # Show server info
          echo "ğŸ“Š Server information:"
          sudo systemctl status minecraft-server --no-pager -l
          
          # Show external IP
          echo "ğŸŒ External IP: $(curl -s ifconfig.me)"
          
          # Show directory structure
          echo "ğŸ“ Directory structure:"
          ls -la /opt/minecraft/
          
          echo "ğŸ® Minecraft server is ready!"
        EOF
        
    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸ‰ Deployment successful! Server is running on $EC2_HOST:25565"
        else
          echo "âŒ Deployment failed. Check the logs above."
        fi
